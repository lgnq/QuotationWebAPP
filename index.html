<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- iOS全屏核心配置 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-touch-fullscreen" content="yes">
  <meta name="theme-color" content="#165DFF">
  <title>欧人民币汇率利润计算器</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://picsum.photos/180/180">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; }
    body { background: #f5f7fa; height: 100vh; padding: 16px; display: flex; flex-direction: column; gap: 16px; }
    .card { background: #fff; border-radius: 18px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .title { font-size: 18px; font-weight: 600; color: #165DFF; margin-bottom: 20px; }
    .rate-wrap { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #f0f0f0; }
    .rate-text { font-size: 15px; color: #666; }
    .rate-val { font-size: 17px; font-weight: 600; color: #165DFF; }
    .refresh-btn { padding: 6px 12px; border: 1px solid #165DFF; border-radius: 8px; color: #165DFF; font-size: 14px; background: #fff; cursor: pointer; }
    .input-item { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .input-item label { width: 90px; font-size: 15px; color: #444; }
    .input-item input { flex: 1; padding: 14px 16px; border: 1px solid #e5e7eb; border-radius: 12px; font-size: 17px; text-align: right; outline: none; }
    .input-item input:focus { border-color: #165DFF; }
    .result-list { margin-top: 20px; }
    .result-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f5f5f5; }
    .result-item:last-child { border-bottom: none; }
    .result-label { font-size: 15px; color: #666; }
    .result-value { font-size: 18px; font-weight: 600; color: #165DFF; }
    /* 数字键盘 */
    .keyboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; flex: 0 0 auto; }
    .key { padding: 20px 0; font-size: 22px; font-weight: 500; border: none; border-radius: 16px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; }
    .key:active { background: #f1f5f9; transform: scale(0.98); }
    .key.clear { background: #ff4d4f; color: #fff; }
    /* 隐藏系统输入法 */
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input { -moz-appearance: textfield; }
    .loading { color: #999; font-size: 14px; }
  </style>
</head>
<body>
  <div class="card" style="flex: 1; display: flex; flex-direction: column;">
    <div class="title">欧元人民币汇率利润计算器</div>
    <!-- 实时汇率区域 -->
    <div class="rate-wrap">
      <div class="rate-text">实时汇率（1 EUR = ? CNY）</div>
      <div>
        <span id="eurCnyRate" class="rate-val">7.80</span>
        <button class="refresh-btn" id="refreshRate">刷新</button>
      </div>
    </div>
    <!-- 输入区域 -->
    <div class="input-item">
      <label>欧元成本</label>
      <input type="text" id="eurCost" readonly placeholder="0.00" />
    </div>
    <div class="input-item">
      <label>利润率(%)</label>
      <input type="number" id="profitRate" value="15" placeholder="请输入利润率" />
    </div>
    <!-- 计算结果 -->
    <div style="flex: 1;"></div>
    <div class="result-list">
      <div class="result-item">
        <span class="result-label">人民币成本</span>
        <span class="result-value" id="cnyCost">0.00</span>
      </div>
      <div class="result-item">
        <span class="result-label">欧元利润</span>
        <span class="result-value" id="eurProfit">0.00</span>
      </div>
      <div class="result-item">
        <span class="result-label">欧元卖价</span>
        <span class="result-value" id="eurSell">0.00</span>
      </div>
      <div class="result-item">
        <span class="result-label">人民币卖价</span>
        <span class="result-value" id="cnySell">0.00</span>
      </div>
    </div>
  </div>

  <!-- 数字键盘 -->
  <div class="card keyboard">
    <button class="key" data-val="1">1</button>
    <button class="key" data-val="2">2</button>
    <button class="key" data-val="3">3</button>
    <button class="key" data-val="4">4</button>
    <button class="key" data-val="5">5</button>
    <button class="key" data-val="6">6</button>
    <button class="key" data-val="7">7</button>
    <button class="key" data-val="8">8</button>
    <button class="key" data-val="9">9</button>
    <button class="key" data-val="0">0</button>
    <button class="key" data-val=".">.</button>
    <button class="key clear" id="clearKey">C</button>
  </div>

  <script>
    // DOM元素
    const eurCnyRate = document.getElementById('eurCnyRate');
    const refreshRate = document.getElementById('refreshRate');
    const eurCost = document.getElementById('eurCost');
    const profitRate = document.getElementById('profitRate');
    const cnyCost = document.getElementById('cnyCost');
    const eurProfit = document.getElementById('eurProfit');
    const eurSell = document.getElementById('eurSell');
    const cnySell = document.getElementById('cnySell');
    const clearKey = document.getElementById('clearKey');
    const keys = document.querySelectorAll('.key[data-val]');
    let currentRate = 7.80; // 本地默认汇率（无网兜底）
    const currentInput = eurCost; // 唯一输入框，固定欧元成本

    // 初始化：拉取实时汇率
    window.onload = () => {
      getRealTimeRate();
      calculateAll();
    };

    // 拉取实时欧元兑人民币汇率（使用免费公开API，无跨域）
    function getRealTimeRate() {
      eurCnyRate.innerHTML = '<span class="loading">刷新中...</span>';
      // 免费API：exchangerate-api，默认拉取最新EUR/CNY
      fetch('https://api.exchangerate-api.com/v4/latest/EUR')
        .then(res => res.json())
        .then(data => {
          if (data.rates && data.rates.CNY) {
            currentRate = parseFloat(data.rates.CNY).toFixed(2);
            eurCnyRate.textContent = currentRate;
          } else {
            eurCnyRate.textContent = currentRate;
          }
        })
        .catch(err => {
          eurCnyRate.textContent = currentRate; // 失败用默认值
        });
    }

    // 数字键盘输入逻辑
    keys.forEach(key => {
      key.addEventListener('click', () => {
        const val = key.dataset.val;
        // 小数点处理：只能有一个，空值时加0再补点
        if (val === '.') {
          if (currentInput.value.includes('.')) return;
          currentInput.value = currentInput.value || '0';
        }
        // 拼接输入值
        currentInput.value += val;
        // 实时计算
        calculateAll();
      });
    });

    // 清空按键
    clearKey.addEventListener('click', () => {
      currentInput.value = '';
      calculateAll();
    });

    // 刷新汇率按钮
    refreshRate.addEventListener('click', getRealTimeRate);

    // 核心计算逻辑
    function calculateAll() {
      const eurCostVal = parseFloat(currentInput.value) || 0;
      const profitRateVal = parseFloat(profitRate.value) || 0;
      const rate = parseFloat(currentRate) || 0;

      // 计算各项值
      const cnyCostVal = (eurCostVal * rate).toFixed(2); // 人民币成本
      const eurProfitVal = (eurCostVal * profitRateVal / 100).toFixed(2); // 欧元利润
      const eurSellVal = (eurCostVal + parseFloat(eurProfitVal)).toFixed(2); // 欧元卖价
      const cnySellVal = (parseFloat(eurSellVal) * rate).toFixed(2); // 人民币卖价

      // 渲染结果
      cnyCost.textContent = cnyCostVal;
      eurProfit.textContent = eurProfitVal;
      eurSell.textContent = eurSellVal;
      cnySell.textContent = cnySellVal;
    }

    // 利润率变化实时计算
    profitRate.addEventListener('input', calculateAll);

    // 注册Service Worker（PWA离线缓存）
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW注册成功'))
          .catch(err => console.log('SW注册失败:', err));
      });
    }
  </script>
</body>
</html>