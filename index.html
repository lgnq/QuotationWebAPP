<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- iOS全屏核心配置 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-touch-fullscreen" content="yes">
  <meta name="theme-color" content="#165DFF">
  <title>Quotation Web App</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://picsum.photos/180/180">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; }
    body { background: #f5f7fa; height: 100vh; padding: 16px 16px 16px 16px; display: flex; flex-direction: column; gap: 16px; }
    .card { background: #fff; border-radius: 0px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .title { font-size: 18px; font-weight: 600; color: #165DFF; margin-bottom: 20px; }
    .rate-wrap { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #f0f0f0; }
    .rate-text { font-size: 15px; color: #666; }
    .rate-val { font-size: 17px; font-weight: 600; color: #165DFF; }
    .refresh-btn { padding: 6px 12px; border: 1px solid #165DFF; border-radius: 8px; color: #165DFF; font-size: 14px; background: #fff; cursor: pointer; }
    .input-item { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .input-item label { width: 150px; font-size: 17px; color: #444; }
    .input-item input { flex: 1; padding: 14px 16px; border: 1px solid #e5e7eb; border-radius: 12px; font-size: 17px; text-align: right; outline: none; }
    .input-item input:focus { border-color: #165DFF; }
    .input-item select { flex: 1; padding: 14px 16px; border: 1px solid #e5e7eb; border-radius: 12px; font-size: 17px; text-align: right; outline: none; }
    .result-list { margin-top: 20px; }
    .result-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f5f5f5; }
    .result-item:last-child { border-bottom: none; }
    .result-label { font-size: 15px; color: #666; }
    .result-value { font-size: 18px; font-weight: 600; color: #165DFF; }
    /* 数字键盘 */
    .keyboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0px; flex: 0 0 auto; }
    .key { padding: 10px 0; font-size: 30px; font-weight: 500; border: none; border-radius: 0px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; }
    .key:active { background: #f1f5f9; transform: scale(0.98); }
    .key.clear { background: #ff4d4f; color: #fff; }
    /* 隐藏系统输入法 */
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input { -moz-appearance: textfield; }
    .loading { color: #999; font-size: 14px; }
  </style>
</head>
<body>
  <div class="card" style="flex: 1; display: flex; flex-direction: column;">
    <div class="title">Quotation Web App</div>
    <!-- 实时汇率区域 -->
    <div class="rate-wrap">
      <div class="rate-text">Exchange Rate（1 EUR = <span id="eurCnyRate" class="rate-val">7.80</span> CNY）@ <span id="date"></span></div>
      <div>
        <button class="refresh-btn" id="refreshRate">Refresh</button>
      </div>
    </div>
    <!-- 输入区域 -->
    <div class="input-item">
      <label>EUR Disti Cost</label>
      <input type="text" style="color: red;" id="eurCost" readonly placeholder="0.000" onfocus="focus_eur_cost()"/>
    </div>
    <div class="input-item">
      <label>USD Disti Cost</label>
      <input type="text" id="usdCost" readonly placeholder="0.000" onfocus="focus_usd_cost()"/>
    </div>    
    <div class="input-item">
      <label>CNY Disti Cost</label>
      <input type="text" id="cnyCost" readonly placeholder="0.000" onfocus="focus_cny_cost()"/>
    </div>
    <div class="input-item">
      <label>Disti Margin(%)</label>
      <!-- <input type="number" id="profitRate" value="15" readonly placeholder="请输入利润率" /> -->
      <select id="disti_margin" onchange="disti_margin_onchange()">
        <option value=0.05>5%</option>
        <option value=0.06>6%</option>
        <option value=0.07>7%</option>
        <option value=0.08>8%</option>
        <option value=0.09>9%</option>
        <option value=0.10 selected>10%</option>
        <option value=0.11>11%</option>
        <option value=0.12>12%</option>
        <option value=0.13>13%</option>
        <option value=0.14>14%</option>
        <option value=0.15>15%</option>
      </select>
    </div>
    <div class="input-item">
      <label>EUR Resale Price</label>
      <input type="text" id="eurSell" readonly placeholder="0.000" onfocus="focus_eur_sell()"/>
    </div>
    <div class="input-item">
      <label>USD Resale Price</label>
      <input type="text" id="usdSell" readonly placeholder="0.000" onfocus="focus_usd_sell()"/>
    </div>    
    <div class="input-item">
      <label>CNY Resale Price</label>
      <input type="text" id="cnySell" readonly placeholder="0.000" onfocus="focus_cny_sell()"/>
    </div>    
    <div class="input-item">
      <label>CNY Resale Price 13% VAT</label>
      <input type="text" id="cnyvatSell" readonly placeholder="0.000" onfocus="focus_cny_vat_sell()"/>
    </div>        
    <!-- 计算结果 -->
    <!-- <div style="flex: 1;"></div> -->
    <!-- <div class="result-list"> -->
      <!-- <div class="result-item">
        <span class="result-label">人民币成本</span>
        <span class="result-value" id="cnyCost">0.00</span>
      </div> -->
      <!-- <div class="result-item">
        <span class="result-label">欧元卖价</span>
        <span class="result-value" id="eurSell">0.00</span>
      </div>
      <div class="result-item">
        <span class="result-label">人民币卖价</span>
        <span class="result-value" id="cnySell">0.00</span>
      </div> -->
    </div>
  </div>

  <!-- 数字键盘 -->
  <div class="keyboard">
    <button class="key" data-val="1">1</button>
    <button class="key" data-val="2">2</button>
    <button class="key" data-val="3">3</button>
    <button class="key" data-val="4">4</button>
    <button class="key" data-val="5">5</button>
    <button class="key" data-val="6">6</button>
    <button class="key" data-val="7">7</button>
    <button class="key" data-val="8">8</button>
    <button class="key" data-val="9">9</button>
    <button class="key" data-val="0">0</button>
    <button class="key" data-val=".">.</button>
    <button class="key clear" id="clearKey">C</button>
  </div>

  <p style="color: lightgray; text-align: center;" >eaf@melexis.com 2026</p>

  <script>
    // DOM元素
    const eurCnyRate = document.getElementById('eurCnyRate');
    const refreshRate = document.getElementById('refreshRate');
    const eurCost = document.getElementById('eurCost');
    const disti_margin = document.getElementById('disti_margin');
    const cnyCost = document.getElementById('cnyCost');
    const usdCost = document.getElementById('usdCost');
    const eurSell = document.getElementById('eurSell');
    const usdSell = document.getElementById('usdSell');
    const cnySell = document.getElementById('cnySell');
    const cnyvatSell = document.getElementById('cnyvatSell');
    const clearKey = document.getElementById('clearKey');
    const keys = document.querySelectorAll('.key[data-val]');
    let currentRate = 7.80; // 本地默认汇率（无网兜底）
    let currentInput = eurCost; // 唯一输入框，固定欧元成本

    const fixed_number = 3;

    let eur_cost = 0;
    let eur_sell = 0;
    let usd_cost = 0;
    let usd_sell = 0;
    let cny_cost = 0;
    let cny_sell = 0;
    let cny_vat_sell = 0;
    
    let margin = 0;
    
    let eur2cny = 0;
    let eur2usd = 0;
    
    let cny2eur = 0;
    let cny2usd = 0;

    let usd2eur = 0;
    let usd2cny = 0;

    // 初始化：拉取实时汇率
    window.onload = () => {
      margin = parseFloat(disti_margin.value) || 0;
      console.log(margin);

      getRealTimeRate();
      // calculateAll();
    };

    // 拉取实时欧元兑人民币汇率（使用免费公开API，无跨域）
    function getRealTimeRate() {
      eurCnyRate.innerHTML = '<span class="loading">刷新中...</span>';
      // 免费API：exchangerate-api，默认拉取最新EUR/CNY
      fetch('https://api.exchangerate-api.com/v4/latest/EUR')
        .then(res => res.json())
        .then(data => {
          if (data.rates && data.rates.CNY) {
            eur2cny = parseFloat(data.rates.CNY).toFixed(fixed_number);
            eur2usd = parseFloat(data.rates.USD).toFixed(fixed_number);
            
            currentRate = parseFloat(data.rates.CNY).toFixed(fixed_number);
            eurCnyRate.textContent = currentRate;
            
            date.textContent = data.date;
          } else {
            eurCnyRate.textContent = currentRate;
          }
        })
        .catch(err => {
          eurCnyRate.textContent = currentRate; // 失败用默认值
        });
    }

    // 数字键盘输入逻辑
    keys.forEach(key => {
      key.addEventListener('click', () => {
        const val = key.dataset.val;
        // 小数点处理：只能有一个，空值时加0再补点
        if (val === '.') {
          if (currentInput.value.includes('.')) return;
          currentInput.value = currentInput.value || '0';
        }
        // 拼接输入值
        currentInput.value += val;
        // 实时计算
        calculateAll();
      });
    });

    // 清空按键
    clearKey.addEventListener('click', () => {
      currentInput.value = '';
      calculateAll();
    });

    // 刷新汇率按钮
    refreshRate.addEventListener('click', getRealTimeRate);

    // 核心计算逻辑
    function calculateAll() {
      if (currentInput.id == 'eurCost')
      {
        eur_cost = parseFloat(currentInput.value) || 0;
        usd_cost = (eur_cost * eur2usd).toFixed(fixed_number);
        cny_cost = (eur_cost * eur2cny).toFixed(fixed_number);

        eur_sell = (eur_cost / (1-margin)).toFixed(fixed_number); // 欧元卖价
        usd_sell = (usd_cost / (1-margin)).toFixed(fixed_number);
        cny_sell = (cny_cost / (1-margin)).toFixed(fixed_number); // 人民币卖价
        
        cny_vat_sell = (cny_sell * 1.13).toFixed(fixed_number);

        // 渲染结果
        usdCost.value = usd_cost;
        cnyCost.value = cny_cost;

        eurSell.value = eur_sell;
        usdSell.value = usd_sell;
        cnySell.value = cny_sell;

        cnyvatSell.value = cny_vat_sell;        
      }
      else if (currentInput.id == 'usdCost')
      {
        usd_cost = parseFloat(currentInput.value) || 0;

        // 计算各项值
        eur_cost = (usd_cost / eur2usd).toFixed(fixed_number);
        cny_cost = (eur_cost * eur2cny).toFixed(fixed_number);

        eur_sell = (eur_cost / (1 - margin)).toFixed(fixed_number); // 欧元卖价
        usd_sell = (usd_cost / (1 - margin)).toFixed(fixed_number);
        cny_sell = (cny_cost / (1 - margin)).toFixed(fixed_number); // 人民币卖价
        
        cny_vat_sell = (cny_sell * 1.13).toFixed(fixed_number);

        // 渲染结果
        eurCost.value = eur_cost;
        cnyCost.value = cny_cost;

        eurSell.value = eur_sell;
        usdSell.value = usd_sell;
        cnySell.value = cny_sell;
        cnyvatSell.value = cny_vat_sell;        
      }      
      else if (currentInput.id == 'cnyCost')
      {
        cny_cost = parseFloat(currentInput.value) || 0;

        // 计算各项值
        eur_cost = (cny_cost / eur2cny).toFixed(fixed_number);
        usd_cost = (eur_cost * eur2usd).toFixed(fixed_number);

        eur_sell = (eur_cost / (1 - margin)).toFixed(fixed_number); // 欧元卖价
        usd_sell = (usd_cost / (1 - margin)).toFixed(fixed_number);
        cny_sell = (cny_cost / (1 - margin)).toFixed(fixed_number); // 人民币卖价
        
        cny_vat_sell = (cny_sell * 1.13).toFixed(fixed_number);

        // 渲染结果
        eurCost.value = eur_cost;
        usdCost.value = usd_cost;

        eurSell.value = eur_sell;
        usdSell.value = usd_sell;
        cnySell.value = cny_sell;
        cnyvatSell.value = cny_vat_sell;        
      }
      else if (currentInput.id == 'eurSell')
      {
        eur_sell = parseFloat(currentInput.value) || 0;

        // 计算各项值
        cny_sell = (eur_sell * eur2cny).toFixed(fixed_number); // 人民币卖价
        usd_sell = (eur_sell * eur2usd).toFixed(fixed_number); // 人民币卖价

        eur_cost = (eur_sell * (1 - margin)).toFixed(fixed_number);
        usd_cost = (usd_sell * (1 - margin)).toFixed(fixed_number);
        cny_cost = (cny_sell * (1 - margin)).toFixed(fixed_number); 
        
        cny_vat_sell = (cny_sell * 1.13).toFixed(fixed_number);

        // 渲染结果
        eurCost.value = eur_cost;
        usdCost.value = usd_cost;
        cnyCost.value = cny_cost;

        usdSell.value = usd_sell;        
        cnySell.value = cny_sell;        
        cnyvatSell.value = cny_vat_sell;        
      }
      else if (currentInput.id == 'usdSell')
      {
        usd_sell = parseFloat(currentInput.value) || 0;

        // 计算各项值
        eur_sell = (usd_sell / eur2usd).toFixed(fixed_number);
        cny_sell = (eur_sell * eur2cny).toFixed(fixed_number); // 人民币卖价

        eur_cost = (eur_sell * (1 - margin)).toFixed(fixed_number);
        usd_cost = (usd_sell * (1 - margin)).toFixed(fixed_number);
        cny_cost = (cny_sell * (1 - margin)).toFixed(fixed_number); 
        
        cny_vat_sell = (cny_sell * 1.13).toFixed(fixed_number);

        // 渲染结果
        eurCost.value = eur_cost;
        usdCost.value = usd_cost;
        cnyCost.value = cny_cost;

        eurSell.value = eur_sell;        
        cnySell.value = cny_sell;        
        cnyvatSell.value = cny_vat_sell;        
      }      
      else if (currentInput.id == 'cnySell')
      {
        cny_sell = parseFloat(currentInput.value) || 0;

        // 计算各项值
        eur_sell = (cny_sell / eur2cny).toFixed(fixed_number); // 人民币成本
        usd_sell = (eur_sell * eur2usd).toFixed(fixed_number); // 人民币成本
        
        eur_cost = (eur_sell * (1 - margin)).toFixed(fixed_number); // 人民币卖价
        usd_cost = (usd_sell * (1 - margin)).toFixed(fixed_number); // 人民币卖价
        cny_cost = (cny_sell * (1 - margin)).toFixed(fixed_number); 
        
        cny_vat_sell = (cny_sell * 1.13).toFixed(fixed_number);

        // 渲染结果
        eurCost.value = eur_cost;
        usdCost.value = usd_cost;
        cnyCost.value = cny_cost;

        eurSell.value = eur_sell;        
        usdSell.value = usd_sell;
        cnyvatSell.value = cny_vat_sell;
      }
      else if (currentInput.id == 'cnyvatSell')
      {
        cny_vat_sell = parseFloat(currentInput.value) || 0;

        // 计算各项值
        cny_sell = (cny_vat_sell / 1.13).toFixed(fixed_number);
        eur_sell = (cny_sell / eur2cny).toFixed(fixed_number); // 人民币成本
        usd_sell = (eur_sell * eur2usd).toFixed(fixed_number); // 人民币成本

        eur_cost = (eur_sell * (1 - margin)).toFixed(fixed_number); // 人民币卖价
        usd_cost = (usd_sell * (1 - margin)).toFixed(fixed_number); // 人民币卖价
        cny_cost = (cny_sell * (1 - margin)).toFixed(fixed_number); 

        // 渲染结果
        eurCost.value = eur_cost;
        usdCost.value = usd_cost;
        cnyCost.value = cny_cost;

        eurSell.value = eur_sell;
        usdSell.value = usd_sell;
        cnySell.value = cny_sell;        
      }      
    }

    function disti_margin_onchange(){
      margin = parseFloat(disti_margin.value)

      eur_cost = parseFloat(eurCost.value) || 0;
      usd_cost = parseFloat(usdCost.value) || 0;
      cny_cost = parseFloat(cnyCost.value) || 0;

      eur_sell = (eur_cost / (1-margin)).toFixed(fixed_number); // 欧元卖价
      usd_sell = (usd_cost / (1-margin)).toFixed(fixed_number);
      cny_sell = (cny_cost / (1-margin)).toFixed(fixed_number); // 人民币卖价
      
      cny_vat_sell = (cny_sell * 1.13).toFixed(fixed_number);

      eurSell.value = eur_sell;        
      usdSell.value = usd_sell;
      cnySell.value = cny_sell;

      cnyvatSell.value = cny_vat_sell;        
    }

    function focus_eur_cost() {
      eurCost.value = '';
      usdCost.value = '';
      cnyCost.value = '';

      eurSell.value = '';
      usdSell.value = '';
      cnySell.value = '';

      cnyvatSell.value = '';

      currentInput = eurCost;
    }

    function focus_usd_cost() {
      eurCost.value = '';
      usdCost.value = '';
      cnyCost.value = '';

      eurSell.value = '';
      usdSell.value = '';
      cnySell.value = '';

      cnyvatSell.value = '';

      currentInput = usdCost;
    }    

    function focus_cny_cost() {
      eurCost.value = '';
      usdCost.value = '';
      cnyCost.value = '';

      eurSell.value = '';
      usdSell.value = '';
      cnySell.value = '';

      cnyvatSell.value = '';

      currentInput = cnyCost;
    }

    function focus_eur_sell() {
      eurCost.value = '';
      usdCost.value = '';
      cnyCost.value = '';

      eurSell.value = '';
      usdSell.value = '';
      cnySell.value = '';

      cnyvatSell.value = '';

      currentInput = eurSell;
    }

    function focus_usd_sell() {
      eurCost.value = '';
      usdCost.value = '';
      cnyCost.value = '';

      eurSell.value = '';
      usdSell.value = '';
      cnySell.value = '';

      cnyvatSell.value = '';

      currentInput = usdSell;
    }

    function focus_cny_sell() {
      eurCost.value = '';
      usdCost.value = '';
      cnyCost.value = '';

      eurSell.value = '';
      usdSell.value = '';
      cnySell.value = '';

      cnyvatSell.value = '';

      currentInput = cnySell;
    }

    function focus_cny_vat_sell() {
      eurCost.value = '';
      usdCost.value = '';
      cnyCost.value = '';

      eurSell.value = '';
      usdSell.value = '';
      cnySell.value = '';

      cnyvatSell.value = '';

      currentInput = cnyvatSell;
    }    

    // 注册Service Worker（PWA离线缓存）
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW注册成功'))
          .catch(err => console.log('SW注册失败:', err));
      });
    }
  </script>
</body>
</html>
